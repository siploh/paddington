<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Paddington Homestay</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Library Excel & PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<!-- Icons dari Google Fonts -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
body{font-family:'Poppins',sans-serif;background:#f0f2f5;margin:0;padding:0;color:#333;}
a{ text-decoration:none; color:inherit; }

header{
  background: #27ae60;
  color:#fff;
  padding:20px 8%;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 4px 12px rgba(0,0,0,.15);
}
header h1{margin:0;font-weight:600;font-size:1.5rem;}

.container{max-width:1200px;margin:30px auto;padding:0 8%;}

.stats-cards{display:flex;gap:20px;margin-bottom:25px;flex-wrap:wrap;}
.stats-cards .card{flex:1;background:#fff;padding:20px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.08);text-align:center;transition:0.3s;}
.stats-cards .card:hover{transform:translateY(-3px);box-shadow:0 12px 25px rgba(0,0,0,.12);}
.stats-cards h3{margin:0 0 10px 0;font-size:1rem;color:#555;}
.stats-cards p{margin:0;font-size:1.5rem;font-weight:600;color:#27ae60;}

.chart-container{background:#fff;padding:20px;border-radius:12px;box-shadow:0 8px 20px rgba(0,0,0,.08);margin-bottom:25px;}

.filters{margin-bottom:25px;display:flex;gap:12px;flex-wrap:wrap;}
.filters input, .filters select{padding:12px 14px;border-radius:8px;border:1px solid #ccc;font-size:0.95rem;transition:0.3s;}
.filters input:focus, .filters select:focus{outline:none;border-color:#27ae60;box-shadow:0 0 5px rgba(39,174,96,0.3);}
.filters button{padding:12px 20px;border:none;border-radius:8px;color:#fff;font-weight:600;cursor:pointer;transition:0.3s;display:flex;align-items:center;gap:6px;font-size:0.95rem;}
.filters button:hover{transform:scale(1.05);box-shadow:0 4px 15px rgba(0,0,0,0.2);}

#btnFilter{background:#27ae60;}
#btnFilter:hover{background:#219150;}
#btnDownloadExcel{background:#2980b9;}
#btnDownloadExcel:hover{background:#1c5980;}
#btnDownloadPDF{background:#8e44ad;}
#btnDownloadPDF:hover{background:#652d90;}

table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 10px 25px rgba(0,0,0,.1);}
th,td{padding:15px 18px;text-align:left;border-bottom:1px solid #eee;font-size:0.95rem;}
th{background: #27ae60; color:#fff;font-weight:600;}
tr:hover{background:#f1f5f9;transition:0.2s;}

button.cancel-btn{padding:6px 10px;border:none;border-radius:5px;background:#e74c3c;color:#fff;font-weight:600;cursor:pointer;transition:0.3s;}
button.cancel-btn:hover{background:#c0392b;}
button.undo-btn{padding:6px 10px;border:none;border-radius:5px;background:#3498db;color:#fff;font-weight:600;cursor:pointer;transition:0.3s;}
button.undo-btn:hover{background:#2980b9;}

@media(max-width:768px){
  header{flex-direction:column;gap:10px;text-align:center;}
  .filters{flex-direction:column;}
  .filters button{width:100%;justify-content:center;}
  th,td{padding:12px;}
  .stats-cards{flex-direction:column;}
}
</style>
</head>
<body>

<header>
  <h1>Admin Dashboard</h1>
  <div><a href="index.html" style="color:#fff;font-weight:500;">üè† Kembali ke Website</a></div>
</header>

<div class="container">
  <div class="stats-cards">
    <div class="card"><h3>Total Booking</h3><p id="totalBooking">0</p></div>
    <div class="card"><h3>Kamar Terisi</h3><p id="bookedRooms">0</p></div>
    <div class="card"><h3>Kamar Tersedia</h3><p id="availableRooms">0</p></div>
  </div>

  <div class="chart-container">
    <canvas id="bookingChart" height="120"></canvas>
  </div>

  <div class="filters">
    <input type="date" id="filterCheckin" placeholder="Check-in">
    <input type="date" id="filterCheckout" placeholder="Check-out">
    <select id="filterTipe"><option value="">Semua Tipe Kamar</option></select>
    <button id="btnFilter"><span class="material-icons">filter_alt</span>Filter</button>
    <button id="btnDownloadExcel"><span class="material-icons">grid_on</span>Excel</button>
    <button id="btnDownloadPDF"><span class="material-icons">picture_as_pdf</span>PDF</button>
  </div>

  <table id="bookingTable">
    <thead>
      <tr>
        <th>Nama</th>
        <th>HP/WA</th>
        <th>Tipe Kamar</th>
        <th>Check-in</th>
        <th>Check-out</th>
        <th>Status</th>
        <th>Aksi</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="7" style="text-align:center;">Memuat data...</td></tr>
    </tbody>
  </table>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwo0y0dOxP8KSl-8B4Y_WuLdHQnIBXWaPDCaMa13qU7iaK05HTMEGWv8m-0Y7pQVz7m/exec";
let bookingData = [];
const tableBody = document.querySelector("#bookingTable tbody");
const filterCheckin = document.getElementById("filterCheckin");
const filterCheckout = document.getElementById("filterCheckout");
const filterTipe = document.getElementById("filterTipe");
let bookingChart;

async function loadBookingData(){
  try{
    const res = await fetch(WEB_APP_URL);
    const data = await res.json();
    bookingData = data.booking.map((b)=>({...b}));
    populateFilterOptions(data.kamar);
    renderTable(bookingData);
  }catch(err){
    tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:red;">Gagal load data</td></tr>`;
    console.error(err);
  }
}

function populateFilterOptions(kamarData){
  filterTipe.innerHTML = `<option value="">Semua Tipe Kamar</option>`;
  kamarData.forEach(k=>{
    const opt = document.createElement("option");
    opt.value = k.Tipe;
    opt.innerText = k.Tipe;
    filterTipe.appendChild(opt);
  });
}

function renderTable(data){
  if(data.length===0){
    tableBody.innerHTML=`<tr><td colspan="7" style="text-align:center;">Tidak ada booking</td></tr>`;
  } else {
    tableBody.innerHTML="";
    data.forEach((b,i)=>{
      const tr = document.createElement("tr");
      const checkinDate = b.Checkin ? new Date(b.Checkin).toLocaleDateString('id-ID',{day:'2-digit',month:'long',year:'numeric'}) : "-";
      const checkoutDate = b.Checkout ? new Date(b.Checkout).toLocaleDateString('id-ID',{day:'2-digit',month:'long',year:'numeric'}) : "-";
      const aksiBtn = b.Status === "Booked" ?
        `<button class="cancel-btn" onclick="updateBookingStatus(${b.id},'Batal')">Batal</button>` :
        `<button class="undo-btn" onclick="updateBookingStatus(${b.id},'Booked')">Undo</button>`;
      tr.innerHTML=`
        <td>${b.Nama||"-"}</td>
        <td>${b.HP||"-"}</td>
        <td>${b.Tipe||"-"}</td>
        <td>${checkinDate}</td>
        <td>${checkoutDate}</td>
        <td id="status-${b.id}">${b.Status}</td>
        <td>${aksiBtn}</td>
      `;
      tableBody.appendChild(tr);
    });
  }
  updateStats();
  updateChart();
}

function updateBookingStatus(id,newStatus){
  fetch(WEB_APP_URL,{
    method:'POST',
    headers:{'Content-Type':'application/x-www-form-urlencoded'},
    body:`action=updateStatus&row=${id}&status=${newStatus}`
  })
  .then(res=>res.json())
  .then(data=>{
    if(data.success){
      const booking = bookingData.find(b=>b.id===id);
      booking.Status=newStatus;
      renderTable(bookingData);
    }
  });
}

function applyFilter(){
  const ci = filterCheckin.value;
  const co = filterCheckout.value;
  const tipe = filterTipe.value;
  let filtered = bookingData.filter(b=>{
    let ok=true;
    if(ci) ok = ok && (new Date(b.Checkin) >= new Date(ci));
    if(co) ok = ok && (new Date(b.Checkout) <= new Date(co));
    if(tipe) ok = ok && (b.Tipe === tipe);
    return ok;
  });
  renderTable(filtered);
}

function updateStats(){
  const total = bookingData.length;
  const booked = bookingData.filter(b => b.Tipe && b.Status !== "Batal").length;
  const totalRoomCount = filterTipe.options.length>1?(filterTipe.options.length-1)*5:10;
  const available = Math.max(totalRoomCount-booked,0);
  document.getElementById("totalBooking").innerText=total;
  document.getElementById("bookedRooms").innerText=booked;
  document.getElementById("availableRooms").innerText=available;
}

function updateChart(){
  const months = ["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"];
  const monthlyBooking = Array(12).fill(0);
  bookingData.forEach(b=>{
    if(b.Checkin && b.Status!=="Batal"){
      const date = new Date(b.Checkin);
      monthlyBooking[date.getMonth()]++;
    }
  });
  const ctx = document.getElementById("bookingChart").getContext("2d");
  if(bookingChart) bookingChart.destroy();
  bookingChart=new Chart(ctx,{
    type:'line',
    data:{
      labels:months,
      datasets:[{
        label:'Booking per Bulan',
        data:monthlyBooking,
        backgroundColor:'rgba(39,174,96,0.2)',
        borderColor:'rgba(39,174,96,1)',
        borderWidth:2,
        tension:0.3,
        fill:true,
        pointBackgroundColor:'#27ae60'
      }]
    },
    options:{
      responsive:true,
      plugins:{legend:{display:true,position:'top'},tooltip:{mode:'index',intersect:false}},
      scales:{y:{beginAtZero:true,stepSize:1},x:{grid:{display:false}}}
    }
  });
}

// Download Excel
document.getElementById("btnDownloadExcel").onclick = function() {
  if (bookingData.length === 0) return alert("Data kosong!");
  const wb = XLSX.utils.book_new();
  const wsData = bookingData.map(b=>({
    Nama: b.Nama || "-",
    HP: b.HP || "-",
    Tipe_Kamar: b.Tipe || "-",
    Checkin: b.Checkin ? new Date(b.Checkin).toLocaleDateString('id-ID') : "-",
    Checkout: b.Checkout ? new Date(b.Checkout).toLocaleDateString('id-ID') : "-",
    Status: b.Status
  }));
  const ws = XLSX.utils.json_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, "Booking");
  XLSX.writeFile(wb, "Booking_Homestay.xlsx");
}

// Download PDF
document.getElementById("btnDownloadPDF").onclick = function() {
  if (bookingData.length === 0) return alert("Data kosong!");
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const columns = ["Nama", "HP/WA", "Tipe Kamar", "Check-in", "Check-out", "Status"];
  const rows = bookingData.map(b => [
    b.Nama||"-",
    b.HP||"-",
    b.Tipe||"-",
    b.Checkin ? new Date(b.Checkin).toLocaleDateString('id-ID') : "-",
    b.Checkout ? new Date(b.Checkout).toLocaleDateString('id-ID') : "-",
    b.Status
  ]);
  doc.autoTable({ head: [columns], body: rows });
  doc.save("Booking_Homestay.pdf");
}

document.getElementById("btnFilter").onclick = applyFilter;
window.onload = loadBookingData;
</script>

</body>
</html>
